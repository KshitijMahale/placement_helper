<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>IntervuLog | Manage Roles</title>
  <link rel="icon" th:href="@{/icon.png}" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap');
    body {
        font-family: 'DM Sans', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen">

<header class="sticky top-0 z-50 bg-white shadow px-6 py-4">
  <div class="max-w-7xl mx-auto flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <a href="/dashboard" class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
      üóÇÔ∏è<span>IntervuLog<span class="text-sm font-medium text-gray-500 ml-1">‚Äì Super Admin</span></span>
    </a>
    <nav class="flex flex-wrap sm:flex-nowrap justify-start sm:justify-end gap-4 sm:gap-6 text-[15px] sm:text-[16px] font-medium text-gray-700">
      <a href="/superadmin/users" class="hover:text-indigo-700 transition">Manage Users</a>
      <a href="/admin/experiences/pending" class="hover:text-indigo-700 transition">Approvals</a>
      <a href="/experience-browser" class="hover:text-indigo-700 transition">Experiences</a>
      <a href="/superadmin/add-experience" class="hover:text-indigo-700 transition">Add Experience</a>
      <a href="/userForm" class="hover:text-indigo-700 transition">Your Info</a>
      <a href="/logout" class="text-red-600 font-semibold hover:underline transition">Logout</a>
    </nav>
  </div>
</header>

<main class="p-6 max-w-6xl mx-auto">
  <h2 class="text-2xl font-semibold text-indigo-700 mb-6">Manage Users</h2>

  <input type="text" id="searchInput" placeholder="Search by email or name..." class="mb-4 w-full max-w-md px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400">

  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full text-sm">
      <thead class="bg-indigo-100 text-indigo-800 font-semibold">
      <tr>
        <th class="text-left px-6 py-3">Email</th>
        <th class="text-left px-6 py-3">Name</th>
        <th class="text-left px-6 py-3">Current Role</th>
        <th class="text-left px-6 py-3">Change Role</th>
      </tr>
      </thead>
      <tbody id="userTableBody" class="divide-y divide-gray-200">
      <tr th:each="user : ${users}" class="hover:bg-gray-50">
        <td class="px-6 py-4" th:text="${user.email}"></td>
        <td class="px-6 py-4" th:text="${user.firstName}"></td>
        <td class="px-6 py-4">
            <span class="inline-block px-2 py-1 text-xs font-medium rounded-full" th:text="${user.userRole}" th:classappend="${user.userRole.name() == 'SUPERADMIN'} ? ' bg-yellow-400 text-yellow-800' : (${user.userRole.name() == 'ADMIN'} ? ' bg-indigo-100 text-indigo-800' : ' bg-gray-100 text-gray-800')"></span>
        </td>
        <td class="px-6 py-4">
          <form th:action="@{/superadmin/users/update-role}" method="post" oninput="checkChange(this)" class="flex items-center gap-2">
            <input type="hidden" name="userId" th:value="${user.id}" />
            <select name="newRole" class="roleSelect px-3 py-2 border border-gray-300 rounded-md text-sm" th:data-current="${user.userRole}">
              <option value="STUDENT" th:selected="${user.userRole.name() == 'STUDENT'}">Student</option>
              <option value="ADMIN" th:selected="${user.userRole.name() == 'ADMIN'}">Admin</option>
              <option value="SUPERADMIN" th:selected="${user.userRole.name() == 'SUPERADMIN'}">Super Admin</option>
            </select>
            <button type="submit" disabled class="px-4 py-1.5 bg-indigo-600 text-white text-sm font-semibold rounded-md hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">Update</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
  <!-- Pagination -->
  <div class="mt-6 flex justify-center items-center gap-4 text-sm">
    <a th:if="${currentPage > 0}"
       th:href="@{/superadmin/users(page=${currentPage - 1}, size=10)}"
       class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">Previous</a>

    <span th:text="'Page ' + (${currentPage + 1}) + ' of ' + ${totalPages}"></span>

    <a th:if="${currentPage < totalPages - 1}"
       th:href="@{/superadmin/users(page=${currentPage + 1}, size=10)}"
       class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">Next</a>
  </div>
</main>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchInput');
    const userTableBody = document.getElementById('userTableBody');

    // Live search filter
    searchInput.addEventListener('input', function () {
      const filter = this.value.toLowerCase();
      const rows = userTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const email = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
        const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        row.classList.toggle('hidden', !(email.includes(filter) || name.includes(filter)));
      });
    });

    // Enable update button only if role is changed
    function checkChange(form) {
      const select = form.querySelector('select');
      const current = select.dataset.current;
      const button = form.querySelector('button');
      button.disabled = (select.value === current);
    }

    // Attach change listener to all select elements
    document.querySelectorAll('form').forEach(form => {
      checkChange(form); // initialize
      form.querySelector('select').addEventListener('change', () => checkChange(form));
    });
  });
</script>
</body>
</html>
