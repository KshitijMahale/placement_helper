<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Internship Experiences</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap');
        body {
            font-family: 'DM Sans', sans-serif;
        }
    </style>
</head>
<body class="min-h-screen m-0 bg-slate-100 text-slate-900">
<header class="bg-white shadow-md py-4 px-6 flex justify-between items-center">
    <a href="/dashboard" class="text-2xl font-bold text-indigo-700">üóÇÔ∏è IntervuLog</a>
    <a href="/logout" class="text-sm text-red-600 font-semibold hover:underline">Logout</a>
</header>
<div class="flex min-h-screen -mt-1">
    <!-- Sidebar Filter -->
    <div class="w-80 bg-white p-6 rounded-none overflow-y-auto ">
        <form class="space-y-4" id="filterForm" method="get" action="/experience-browser">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-800">Filter</h2>
                <button type="button" onclick="window.location.href='/experience-browser'" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-md">Reset</button>
            </div>

            <div>
                <label for="year" class="block font-medium text-sm">Select Year <span class="text-red-600">*</span>:</label>
                <select id="year" name="year" required class="w-full mt-1 p-2 border border-slate-300 rounded-xl">
                    <option th:each="yr : ${years}" th:value="${yr}" th:text="${yr}" th:selected="${selectedYear == null ? yr == 2025 : selectedYear == yr}"></option>
                </select>
            </div>

            <div>
                <label for="name" class="block font-medium text-sm">Search by Student Name:</label>
                <input type="text" id="name" name="name" placeholder="Enter student name" th:value="${selectedName}" class="w-full mt-1 p-2 border border-slate-300 rounded-xl">
            </div>

            <div>
                <label for="company" class="block font-medium text-sm">Company:</label>
                <select id="company" name="company" class="w-full mt-1 p-2 border border-slate-300 rounded-xl">
                    <option value="">-- Select Company --</option>
                    <option th:each="company : ${companies}" th:value="${company.name}" th:text="${company.name}" th:selected="${selectedCompany != null and selectedCompany.contains(company.name)}">Company Name</option>
                </select>
            </div>

            <fieldset class="space-y-2">
                <legend class="font-medium text-sm">Role:</legend>
                <span class="me-4"><input type="checkbox" name="role" value="SDE" th:checked="${selectedRole != null and selectedRole.contains('SDE')}"> SDE</span>
                <span class="me-4"><input type="checkbox" name="role" value="Business Analyst" th:checked="${selectedRole != null and selectedRole.contains('Business Analyst')}"> Business Analyst</span>
                <span class="me-4"><input type="checkbox" name="role" value="Manager" th:checked="${selectedRole != null and selectedRole.contains('Manager')}"> Manager</span>
            </fieldset>

            <fieldset class="space-y-2">
                <legend class="font-medium text-sm">Offer Type:</legend>
                <div><input type="checkbox" name="type" value="InternshipOnly" th:checked="${selectedType != null and selectedType.contains('InternshipOnly')}"> Internship Only</div>
                <div><input type="checkbox" name="type" value="Internship(performance-based offer)" th:checked="${selectedType != null and selectedType.contains('Internship(performance-based offer)')}"> Internship (performance-based offer)</div>
                <div><input type="checkbox" name="type" value="InternshipPlacement" th:checked="${selectedType != null and selectedType.contains('InternshipPlacement')}"> Internship + Placement</div>
                <div><input type="checkbox" name="type" value="PlacementOnly" th:checked="${selectedType != null and selectedType.contains('PlacementOnly')}"> Placement Only</div>
            </fieldset>

            <div>
                <label class="block font-medium text-sm">CTC Range (‚Çπ):</label>
                <div class="flex space-x-2 mt-1">
                    <input type="number" name="ctcMin" placeholder="Min" th:value="${selectedCtcMin}" class="w-1/2 p-2 border border-slate-300 rounded-xl">
                    <input type="number" name="ctcMax" placeholder="Max" th:value="${selectedCtcMax}" class="w-1/2 p-2 border border-slate-300 rounded-xl">
                </div>
            </div>

            <div>
                <label class="block font-medium text-sm">Stipend Range (‚Çπ):</label>
                <div class="flex space-x-2 mt-1">
                    <input type="number" name="stipendMin" placeholder="Min" th:value="${selectedStipendMin}" class="w-1/2 p-2 border border-slate-300 rounded-xl">
                    <input type="number" name="stipendMax" placeholder="Max" th:value="${selectedStipendMax}" class="w-1/2 p-2 border border-slate-300 rounded-xl">
                </div>
            </div>


        </form>
    </div>

    <!-- Main Content: Experience List + Details -->
    <div class="flex-1 flex p-6 gap-6 overflow-hidden">
        <!-- Experience List -->
        <div class="w-2/5 h-full bg-white p-6 rounded-3xl shadow-2xl overflow-y-auto">
            <h2 class="text-xl font-semibold mb-4 text-slate-800">Experiences</h2>
            <div th:each="experience : ${experiences}"
                 class="bg-indigo-50 hover:bg-indigo-100 p-4 rounded-xl shadow-sm mb-3 cursor-pointer transition duration-200 ease-in-out"
                 th:attr="data-id=${experience.id}"
                 onclick="loadExperienceDetails(this)">
                <strong th:text="${experience.fullName}" class="text-indigo-900 mr-4">Name</strong>
                <span th:text="${experience.course}" class="text-slate-600">Course</span> -
                <span th:text="${experience.company != null ? experience.company.name : 'N/A'}" class="text-slate-600">Company</span> -
                <span th:text="${experience.jobProfile}" class="text-slate-600">Job</span>
            </div>
        </div>

        <!-- Details Panel -->
        <div class="w-3/5 h-full bg-white p-6 rounded-3xl shadow-2xl overflow-y-auto" id="details-panel">
            <h3 class="text-xl font-semibold mb-2 text-slate-800">Experience Details</h3>
            <p class="text-slate-500">Select an experience to see details.</p>
        </div>

    </div>
</div>

<script>
    let activeInputId = null;
    let caretPosition = null;

    function storeCaretPosition(el) {
        if (el && el.id) {
            activeInputId = el.id;
            caretPosition = el.selectionStart;
            localStorage.setItem("activeInputId", activeInputId);
            localStorage.setItem("caretPosition", caretPosition);
        }
    }

    const form = document.getElementById('filterForm');

    // Auto-submit
    form.querySelectorAll('select, input[type=radio], input[type=checkbox]').forEach(element => {
        element.addEventListener('change', () => {
            form.submit();
        });
    });
    const debounce = (fn, delay) => {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    };
    form.querySelectorAll('input[type=text], input[type=number]').forEach(el => {
      el.addEventListener('input', debounce(() => {
        storeCaretPosition(el);
        form.submit();
      }, 600));
    });

    function generateRoundsHTML(roundsRaw) {
        if (!roundsRaw) return "<p>No rounds data.</p>";
        let rounds;
        try {
            rounds = typeof roundsRaw === 'string' ? JSON.parse(roundsRaw) : roundsRaw;
        } catch (e) {
            console.error("Invalid rounds JSON:", e);
            return "<p>Failed to parse rounds data.</p>";
        }
        if (!Array.isArray(rounds) || rounds.length === 0) return "<p>No rounds data.</p>";
        return rounds.map((round, i) => `
            <div>
                <strong>Round ${i + 1} (${round.roundType || "N/A"}):</strong>
                <ul>
                    ${(round.questions || []).map(q => `<li>${q}</li>`).join('')}
                </ul>
            </div>
        `).join('');
    }

    function loadExperienceDetails(element) {
        const id = element.getAttribute("data-id");
        fetch(`experience-browser/${id}`)
            .then(response => response.json())
            .then(data => {
                const panel = document.getElementById("details-panel");

                let rounds = "";
                if (data.rounds && Array.isArray(data.rounds)) {
                    rounds = data.rounds.map((round, index) => `
                        <div>
                            <strong>Round ${index + 1} (${round.roundType}):</strong>
                            <ul>
                                ${round.questions.map(q => `<li>${q}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('');
                }

                panel.innerHTML = `
                    <h3 class="text-xl font-bold text-indigo-800 mb-4">${data.company?.name || "N/A"} ‚Äì ${data.jobProfile || "N/A"}</h3>

                    <div class="space-y-2 text-slate-700">
                        <p><strong>Name:</strong> ${data.fullName || "N/A"}</p>
                        <p><strong>Course:</strong> ${data.course || "N/A"}</p>
                        <p><strong>Company:</strong> ${data.company?.name || "N/A"}</p>
                        ${data.otherCompany && data.otherCompany.trim() !== "" ? `<p><strong>Other Company:</strong> ${data.otherCompany}</p>` : ""}
                        <p><strong>Job Profile:</strong> ${data.jobProfile || "N/A"}</p>
                        ${data.otherJobProfile && data.otherJobProfile.trim() !== "" ? `<p><strong>Other Job Profile:</strong> ${data.otherJobProfile}</p>` : ""}
                        <p><strong>Offer Type:</strong> ${data.offerType || "N/A"}</p>
                        <p><strong>CTC:</strong> ‚Çπ${data.ctc || "N/A"}</p>
                        <p><strong>Internship Stipend:</strong> ‚Çπ${data.internshipStipend || "N/A"}</p>
                        <p><strong>Location:</strong> ${data.location?.name || "N/A"}</p>
                        <p><strong>Process Date:</strong> ${data.processDate || "N/A"}</p>
                    </div>

                    <div class="mt-6">
                        <h4 class="text-lg font-semibold text-slate-800 mb-2">Interview Rounds</h4>
                        ${generateRoundsHTML(data.rounds)}
                    </div>

                    <div class="mt-4 text-slate-700">
                        <p><strong>Comments:</strong><br>${(data.comments || "No comments")
                            .replace(/\r?\n/g, '<br>')
                            .replace(/\+/g, '')}</p>
                    </div>

                    <div class="mt-2">
                        <p><strong>LinkedIn:</strong> ${data.linkedin ? `<a href="${data.linkedin}" target="_blank" class="text-blue-600 underline">${data.linkedin}</a>` : "N/A"}</p>
                    </div>
                `;

            })
            .catch(error => {
                console.error("Error fetching details:", error);
            });
    }

    window.addEventListener("DOMContentLoaded", () => {
        const savedId = localStorage.getItem("activeInputId");
        const savedCaret = parseInt(localStorage.getItem("caretPosition"), 10);

        if (savedId && !isNaN(savedCaret)) {
            const input = document.getElementById(savedId);
            if (input) {
                input.focus();
                input.setSelectionRange(savedCaret, savedCaret);
            }
        }

        // cleanup
        localStorage.removeItem("activeInputId");
        localStorage.removeItem("caretPosition");
    });
</script>

</body>
</html>
