<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
    <meta charset="UTF-8" />
    <title>IntervuLog | Interview Experiences</title>
    <link rel="icon" th:href="@{/icon.png}" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap');
        body {
            font-family: 'DM Sans', sans-serif;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-slate-100 text-slate-900">
<!--    header -->
<div sec:authorize="hasRole('SUPERADMIN')">
    <div th:replace="~{fragments/superadmin-header :: superadminHeader}"></div>
</div>

<div sec:authorize="hasRole('ADMIN') and not hasRole('SUPERADMIN')">
    <div th:replace="~{fragments/admin-header :: adminHeader}"></div>
</div>

<div sec:authorize="hasRole('STUDENT') and not hasRole('ADMIN')">
    <div th:replace="~{fragments/student-header :: studentHeader}"></div>
</div>
<div class="flex flex-1 overflow-hidden">
    <!-- Sidebar Filter -->
    <div class="w-80 bg-white p-6 overflow-y-auto h-full">
    <form class="space-y-4" id="filterForm" method="get" action="/experience-browser">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-slate-800">Filter</h2>
                <button type="button" onclick="window.location.href='/experience-browser'" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-md">Reset</button>
            </div>

            <div>
                <label for="year" class="block font-bold text-sm">Select Year <span class="text-red-600">*</span>:</label>
                <select id="year" name="year" required class="w-full mt-1 p-2 border border-slate-300 rounded-xl">
                    <option th:each="yr : ${years}" th:value="${yr}" th:text="${yr}" th:selected="${selectedYear == null ? yr == 2025 : selectedYear == yr}"></option>
                </select>
            </div>

            <div>
                <label for="name" class="block font-bold text-sm">Search by Student Name:</label>
                <input type="text" id="name" name="name" placeholder="Enter student name" th:value="${selectedName}" class="w-full mt-1 p-2 border border-slate-300 rounded-xl">
            </div>

            <div>
                <label for="company" class="block font-bold text-sm">Company:</label>
                <select id="company" name="company" class="w-full mt-1 p-2 border border-slate-300 rounded-xl">
                    <option value="">-- Select Company --</option>
                    <option th:each="company : ${companies}" th:value="${company.name}" th:text="${company.name}" th:selected="${selectedCompany != null and selectedCompany.contains(company.name)}">Company Name</option>
                </select>
            </div>

            <fieldset class="space-y-2">
                <legend class="text-sm font-bold text-slate-700 mb-1">Select Role(s):</legend>
                <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-slate-700">
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="AI Engineer" th:checked="${selectedRole != null and selectedRole.contains('AI Engineer')}" class="accent-indigo-600"> AI Eng
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="App Developer" th:checked="${selectedRole != null and selectedRole.contains('App Developer')}" class="accent-indigo-600"> App Dev
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Associate Manager" th:checked="${selectedRole != null and selectedRole.contains('Associate Manager')}" class="accent-indigo-600"> Assoc. Manager
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Business Analyst" th:checked="${selectedRole != null and selectedRole.contains('Business Analyst')}" class="accent-indigo-600"> Business Analyst
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Data Analyst" th:checked="${selectedRole != null and selectedRole.contains('Data Analyst')}" class="accent-indigo-600"> Data Analyst
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Data Scientist" th:checked="${selectedRole != null and selectedRole.contains('Data Scientist')}" class="accent-indigo-600"> Data Scientist
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Java Developer" th:checked="${selectedRole != null and selectedRole.contains('Java Developer')}" class="accent-indigo-600"> Java Dev
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Machine Learning Engineer" th:checked="${selectedRole != null and selectedRole.contains('Machine Learning Engineer')}" class="accent-indigo-600"> ML Eng
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="SDE" th:checked="${selectedRole != null and selectedRole.contains('SDE')}" class="accent-indigo-600"> SDE
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="checkbox" name="role" value="Software Developer" th:checked="${selectedRole != null and selectedRole.contains('Software Developer')}" class="accent-indigo-600"> Software Dev
                    </label>
                </div>
            </fieldset>

            <fieldset class="space-y-2">
                <legend class="text-sm font-bold">Offer Type:</legend>
                <div><input type="checkbox" name="type" value="InternshipOnly" th:checked="${selectedType != null and selectedType.contains('InternshipOnly')}"> Internship Only</div>
                <div><input type="checkbox" name="type" value="Internship(performance-based offer)" th:checked="${selectedType != null and selectedType.contains('Internship(performance-based offer)')}"> Internship (performance-based offer)</div>
                <div><input type="checkbox" name="type" value="InternshipPlacement" th:checked="${selectedType != null and selectedType.contains('InternshipPlacement')}"> Internship + Placement</div>
                <div><input type="checkbox" name="type" value="PlacementOnly" th:checked="${selectedType != null and selectedType.contains('PlacementOnly')}"> Placement Only</div>
            </fieldset>

            <div class="mt-4">
                <div>
                    <label class="block font-bold text-sm">CTC Minimum (₹):</label>
                    <input type="number" name="ctcMin" id="ctcMin" placeholder="Min" th:value="${selectedCtcMin}" class="w-full mt-1 p-2 border border-slate-300 rounded-xl" onchange="updateCtcMaxRadios()">
                </div>

                <label class="block font-bold text-sm mt-1 mb-1">CTC Maximum (based on Min):</label>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="ctcMaxOption" value="2" th:checked="${selectedCtcMax != null && selectedCtcMin != null && selectedCtcMax - selectedCtcMin == 200000}" class="mr-1">+2L
                    </label><br>

                    <label class="flex items-center">
                        <input type="radio" name="ctcMaxOption" value="5" th:checked="${selectedCtcMax != null && selectedCtcMin != null && selectedCtcMax - selectedCtcMin == 500000}" class="mr-1">+5L
                    </label><br>

                    <label class="flex items-center">
                        <input type="radio" name="ctcMaxOption" value="10" th:checked="${selectedCtcMax != null && selectedCtcMin != null && selectedCtcMax - selectedCtcMin == 1000000}" class="mr-1">+10L
                    </label><br>

                    <label class="flex items-center">
                        <input type="radio" name="ctcMaxOption" value="all" th:checked="${selectedCtcMax == null || selectedCtcMax == 0}" class="mr-1">All above minimum
                    </label>
                    <input type="hidden" id="ctcMax" name="ctcMax" th:value="${selectedCtcMax}">
                </div>
            </div>

            <div class="mt-4">
                <div>
                    <label class="block font-bold text-sm">Stipend Minimum (₹):</label>
                    <input type="number" id="stipendMin" name="stipendMin" placeholder="Min" th:value="${selectedStipendMin}" class="w-full p-2 border border-slate-300 rounded-xl">
                </div>

                <label class="block font-bold text-sm mb-1">Stipend Maximum (based on Min):</label>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="stipendMaxOption" value="10" th:checked="${selectedStipendMax != null && selectedStipendMin != null && selectedStipendMax - selectedStipendMin == 10000}" class="mr-1">+10K
                    </label><br>

                    <label class="flex items-center">
                        <input type="radio" name="stipendMaxOption" value="20" th:checked="${selectedStipendMax != null && selectedStipendMin != null && selectedStipendMax - selectedStipendMin == 20000}" class="mr-1">+20K
                    </label><br>

                    <label class="flex items-center">
                        <input type="radio" name="stipendMaxOption" value="50" th:checked="${selectedStipendMax != null && selectedStipendMin != null && selectedStipendMax - selectedStipendMin == 50000}" class="mr-1">+50K
                    </label><br>

                    <label class="flex items-center">
                        <input type="radio" name="stipendMaxOption" value="all" th:checked="${selectedStipendMax == null || selectedStipendMax == 0}" class="mr-1">All above minimum
                    </label>
                    <input type="hidden" id="stipendMax" name="stipendMax" th:value="${selectedStipendMax}">
                </div>
            </div>
        </form>
    </div>

    <!-- Main Content: Experience List + Details -->
    <div class="flex-1 flex p-6 gap-6 overflow-hidden">
        <!-- Experience List -->
        <div class="w-2/5 bg-white p-6 rounded-3xl shadow-2xl overflow-y-auto h-full">
        <h2 class="text-xl font-semibold mb-4 text-slate-800">Experiences</h2>
            <div th:each="experience : ${experiences}"
                 class="bg-indigo-50 hover:bg-indigo-100 p-4 rounded-xl shadow-sm mb-3 cursor-pointer transition duration-200 ease-in-out"
                 th:attr="data-id=${experience.id}"
                 onclick="loadExperienceDetails(this)">
                <strong th:text="${experience.fullName}" class="text-indigo-900 mr-4">Name</strong>
                <span th:text="${experience.course}" class="text-slate-600">Course</span> -
                <span th:text="${experience.company != null && experience.company.name == 'Other' ? experience.otherCompany : (experience.company != null ? experience.company.name : 'N/A')}" class="text-slate-600">Company</span> -
                <span th:text="${experience.jobProfile == 'Other' ? experience.otherJobProfile : experience.jobProfile}" class="text-slate-600">Job</span>
            </div>
            <!-- Pagination -->
            <div class="flex justify-center items-center mt-4 gap-2">
                <a th:if="${currentPage > 0}"
                   th:href="@{/experience-browser(page=${currentPage - 1}, size=${size}, year=${selectedYear})}"
                   class="px-4 py-2 bg-indigo-200 hover:bg-indigo-300 text-sm rounded-full">Previous</a>

                <span class="px-4 py-2 text-sm text-slate-600">
                Page <span th:text="${currentPage + 1}"></span> of <span th:text="${totalPages}"></span>
            </span>
                <a th:if="${currentPage + 1 < totalPages}"
                   th:href="@{/experience-browser(page=${currentPage + 1}, size=${size}, year=${selectedYear})}"
                   class="px-4 py-2 bg-indigo-200 hover:bg-indigo-300 text-sm rounded-full">Next</a>
            </div>
        </div>

        <!-- Details Panel -->
        <div class="w-3/5 bg-white p-6 rounded-3xl shadow-2xl overflow-y-auto h-full" id="details-panel">
            <h3 class="text-xl font-semibold mb-2 text-slate-800">Experience Details</h3>
            <p class="text-slate-500">Select an experience to see details.</p>
        </div>

    </div>
</div>

<script>
    let activeInputId = null;
    let caretPosition = null;

    function storeCaretPosition(el) {
        if (el && el.id) {
            activeInputId = el.id;
            caretPosition = el.selectionStart;
            localStorage.setItem("activeInputId", activeInputId);
            localStorage.setItem("caretPosition", caretPosition);
        }
    }

    const form = document.getElementById('filterForm');

    // Auto-submit
    form.querySelectorAll('select, input[type=radio], input[type=checkbox]').forEach(element => {
        element.addEventListener('change', () => {
            form.submit();
        });
    });
    const debounce = (fn, delay) => {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    };
    form.querySelectorAll('input[type=text], input[type=number]').forEach(el => {
      el.addEventListener('input', debounce(() => {
        storeCaretPosition(el);
        form.submit();
      }, 1000));
    });

    function generateRoundsHTML(roundsRaw) {
        if (!roundsRaw) return "<p>No rounds data.</p>";
        let rounds;
        try {
            rounds = typeof roundsRaw === 'string' ? JSON.parse(roundsRaw) : roundsRaw;
        } catch (e) {
            console.error("Invalid rounds JSON:", e);
            return "<p>Failed to parse rounds data.</p>";
        }
        if (!Array.isArray(rounds) || rounds.length === 0) return "<p>No rounds data.</p>";
        return rounds.map((round, i) => {
            const roundName = round.roundType === "Other" ? (round.otherRoundType || "Other") : (round.roundType || "N/A");
            return `
                <div>
                    <strong>Round ${i + 1} (${roundName}):</strong>
                    <ul>
                        ${(round.questions || []).map(q => `<li>${q}</li>`).join('')}
                    </ul>
                </div>
            `;
        }).join('');
    }

    function renderCommentWithLinks(comment) {
        if (!comment) return "<p>No comments</p>";

        const lines = comment.split(/\r?\n/);
        return lines.map(line => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;   // Match links in line
            const linkedLine = line.replace(urlRegex, url =>
                `<a href="${url}" class="text-blue-600 underline" target="_blank">${url}</a>`
            );
            return `<p>${linkedLine}</p>`;
        }).join('');
    }

    function loadExperienceDetails(element) {
        const id = element.getAttribute("data-id");
        fetch(`experience-browser/${id}`)
            .then(response => response.json())
            .then(data => {
                const panel = document.getElementById("details-panel");

                let rounds = "";
                if (data.rounds && Array.isArray(data.rounds)) {
                    rounds = data.rounds.map((round, index) => `
                        <div>
                            <strong>Round ${index + 1} (${round.roundType}):</strong>
                            <ul>
                                ${round.questions.map(q => `<li>${q}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('');
                }

                panel.innerHTML = `
                    <h3 class="text-xl font-bold text-indigo-800 mb-4">${data.company?.name || "N/A"} – ${data.jobProfile || "N/A"}</h3>

                    <div class="space-y-2 text-slate-700">
                        <p><strong>Name:</strong> ${data.fullName || "N/A"}</p>
                        <p><strong>Course:</strong> ${data.course || "N/A"}</p>
                        <p><strong>Company:</strong> ${
                            data.company?.name === "Other"
                                ? (data.otherCompany || "Other")
                                : (data.company?.name || "N/A")
                        }</p>
                        <p><strong>Job Profile:</strong> ${
                            data.jobProfile === "Other"
                                ? (data.otherJobProfile || "Other")
                                : (data.jobProfile || "N/A")
                        }</p>
                        <p><strong>Offer Type:</strong> ${data.offerType || "N/A"}</p>
                        <p><strong>Location:</strong> ${data.location?.name || "N/A"}</p>
                        <p><strong>Process Date:</strong> ${data.processDate || "N/A"}</p>
                    </div>

                    <div class="mt-3">
                        <h4 class="text-lg font-semibold text-slate-800">Interview Rounds</h4>
                        ${generateRoundsHTML(data.rounds)
                        .replace(/\r?\n/g, '<br>')
                            .replace(/\+/g, '')}
                    </div>

                    <div class="text-slate-700">
                        <p><strong>Comments:</strong></p>
                        ${renderCommentWithLinks(data.comments)}
                    </div>

                    <div class="mt-2">
                        <p><strong>LinkedIn:</strong> ${data.linkedin ? `<a href="${data.linkedin}" target="_blank" class="text-blue-600 underline">${data.linkedin}</a>` : "N/A"}</p>
                    </div>
                `;

            })
            .catch(error => {
                console.error("Error fetching details:", error);
            });
    }

    function setupCtcRangeRadios() {
        const ctcMinInput = document.getElementById("ctcMin");
        const ctcMaxHidden = document.getElementById("ctcMax");
        const radios = document.getElementsByName("ctcMaxOption");

        function updateMax() {
            const min = parseInt(ctcMinInput.value) || 0;
            radios.forEach(radio => {
                if (radio.checked) {
                    if (radio.value === "all") {
                        ctcMaxHidden.value = "";
                    } else {
                        ctcMaxHidden.value = min + parseInt(radio.value) * 100000;
                    }
                    form.submit();
                }
            });
        }

        // Listen for radio changes
        radios.forEach(radio => {
            radio.addEventListener("change", updateMax);
        });

        // Update on min input change too
        ctcMinInput.addEventListener("change", updateMax);
    }

    function setupStipendRangeRadios() {
        const stipendMinInput = document.getElementById("stipendMin");
        const stipendMaxHidden = document.getElementById("stipendMax");
        const radios = document.getElementsByName("stipendMaxOption");

        function updateMax() {
            const min = parseInt(stipendMinInput.value) || 0;
            radios.forEach(radio => {
                if (radio.checked) {
                    if (radio.value === "all") {
                        stipendMaxHidden.value = "";
                    } else {
                        stipendMaxHidden.value = min + parseInt(radio.value) * 1000;
                    }
                    form.submit();
                }
            });
        }

        radios.forEach(radio => {
            radio.addEventListener("change", updateMax);
        });
        stipendMinInput.addEventListener("change", updateMax);
    }

    window.addEventListener("DOMContentLoaded", () => {
        const savedId = localStorage.getItem("activeInputId");
        const savedCaret = parseInt(localStorage.getItem("caretPosition"), 10);

        if (savedId && !isNaN(savedCaret)) {
            const input = document.getElementById(savedId);
            if (input) {
                input.focus();
                input.setSelectionRange(savedCaret, savedCaret);
            }
        }

        setupCtcRangeRadios();
        setupStipendRangeRadios();

        // cleanup
        localStorage.removeItem("activeInputId");
        localStorage.removeItem("caretPosition");
    });
</script>

</body>
</html>
