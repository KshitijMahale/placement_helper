<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IntervuLog | Interview Experience Form</title>
  <link rel="icon" th:href="@{/icon.png}" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap');
    body {
        font-family: 'DM Sans', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<!--    header -->
<div sec:authorize="hasRole('SUPERADMIN')">
  <div th:replace="~{fragments/superadmin-header :: superadminHeader}"></div>
</div>

<div sec:authorize="hasRole('ADMIN') and not hasRole('SUPERADMIN')">
  <div th:replace="~{fragments/admin-header :: adminHeader}"></div>
</div>

<div sec:authorize="hasRole('STUDENT') and not hasRole('ADMIN')">
  <div th:replace="~{fragments/student-header :: studentHeader}"></div>
</div>

<div class="max-w-4xl mx-auto px-4 py-8">

  <h1 class="text-3xl font-bold mb-4">Interview Details Submission</h1>

  <div th:if="${noExperience}">
    <form id="internshipForm" action="/submit-experience" method="post" th:action="@{/submit-experience}" class="space-y-8 bg-white p-6 rounded shadow">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

      <div>
        <h2 class="text-xl font-semibold mb-2">Personal Information</h2>
        <label class="block font-medium">Full Name:</label>
        <input type="text" id="fullName" name="fullName" placeholder="FirstName Surname" required class="w-full border rounded p-2 mt-1">
      </div>

      <div>
        <label class="block font-medium">Course/Branch:</label>
        <select id="course" name="course" required class="w-full border rounded p-2 mt-1">
          <option value="COMP">Comp</option>
          <option value="EXTC">EXTC</option>
          <option value="DS">CSE - DS</option>
          <option value="AIML">CSE - AIML</option>
          <option value="MCA">MCA</option>
          <option value="Mtech">Mtech</option>
        </select>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">Company & Job Details</h2>
        <label class="block font-medium">Company:</label>
        <select id="company" name="company" onchange="toggleCompanyInput()" required class="w-full border rounded p-2 mt-1">
          <option th:each="company : ${companies}" th:value="${company.name}" th:text="${company.name}"></option>
          <option value="Other">Other</option>
        </select>

        <div id="companyInputDiv" style="display: none;" class="mt-2">
          <label class="block font-medium">Please specify the company name:</label>
          <input type="text" id="otherCompany" name="otherCompany" placeholder="Enter company name" class="w-full border rounded p-2 mt-1">
        </div>
      </div>

      <div>
        <label for="jobProfile" class="block font-medium">Job Profile:</label>
        <select id="jobProfile" name="jobProfile" onchange="toggleJobProfileInput()" required class="w-full border rounded p-2 mt-1">
          <option value="" disabled selected>Select a job profile</option>
          <option value="AI Engineer">AI Engineer</option>
          <option value="App Developer">App Developer</option>
          <option value="Associate Manager">Associate Manager</option>
          <option value="Business Analyst">Business Analyst</option>
          <option value="Data Analyst">Data Analyst</option>
          <option value="Data Scientist">Data Scientist</option>
          <option value="Java Developer">Java Developer</option>
          <option value="Machine Learning Engineer">Machine Learning Engineer</option>
          <option value="SDE">SDE</option>
          <option value="Software Developer">Software Developer</option>
          <option value="Other">Other</option>
        </select>

        <div id="jobProfileInputDiv" style="display: none;" class="mt-2">
          <label class="block font-medium">Please specify the job profile:</label>
          <input type="text" id="otherJobProfile" name="otherJobProfile" placeholder="Enter job profile" class="w-full border rounded p-2 mt-1">
        </div>
      </div>

      <div>
        <label class="block font-medium">Offer Type:</label>
        <select id="offerType" name="offerType" onchange="toggleOfferFields()" required class="w-full border rounded p-2 mt-1">
          <option value="Internship(performance-based offer)">Internship (performance-based offer)</option>
          <option value="InternshipOnly">Internship only</option>
          <option value="PlacementOnly">Placement only</option>
          <option value="InternshipPlacement">Internship + Placement</option>
        </select>
      </div>

      <div id="stipendDiv">
        <label class="block font-medium">Internship Stipend:</label>
        <input type="text" id="internshipStipend" name="internshipStipend" placeholder="20000" class="w-full border rounded p-2 mt-1">
      </div>

      <div id="ctcDiv">
        <label class="block font-medium">CTC (in LPA):</label>
        <input type="text" id="ctc" name="ctc" placeholder="For 8LPA -> 800000" class="w-full border rounded p-2 mt-1">
      </div>

      <div>
        <label class="block font-medium">Location:</label>
        <select id="location" name="location" required class="w-full border rounded p-2 mt-1">
          <option value="" disabled selected>Select a location</option>
          <option th:each="loc : ${locations}" th:value="${loc.name}" th:text="${loc.name}"></option>
        </select>
      </div>

      <div>
        <label class="block font-medium">Process Date:</label>
        <input type="date" id="processDate" name="processDate" required class="w-full border rounded p-2 mt-1">
      </div>

      <div>
        <h2 class="text-xl font-semibold">Placement Process</h2>
        <div id="roundsContainer" class="space-y-6">
          <!--  Interview Rounds  -->
        </div>
        <button type="button" onclick="addRound()" class="mt-3 mb-3 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">+ Add New Round</button>

        <div>
          <h2 class="text-xl font-semibold">Additional Information</h2>
          <label class="block font-medium">LinkedIn Profile (optional):</label>
          <input type="url" id="linkedin" name="linkedin" class="w-full border rounded p-2 mt-1">

          <label for="comments" class="block text-sm font-medium">Additional Comments or Advice</label>
          <textarea id="comments" name="comments" rows="5" class="w-full border rounded-md px-3 py-2 shadow-sm"
                    placeholder="You can paste helpful links too, like YouTube, Whimsical, etc.&#10;Example:&#10;For OOPS: https://whimsical.com/oops-link"></textarea>
        </div>

        <input type="submit" value="Submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700 transition">
      </div>
    </form>
  </div>

  <!--  If experience submitted  -->
  <div th:if="${experiences != null and !#lists.isEmpty(experiences)}" class="bg-green-50 border border-green-200 text-green-800 p-4 rounded-md mt-8 shadow">
    <p class="flex items-center gap-2 font-medium">
      <span class="text-lg">âœ…</span> You have already submitted your experience. Thank you!
    </p>
  </div>

  <div th:if="${experiences != null}" class="mt-10">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Submitted Experiences</h2>

    <div th:each="experience : ${experiences}" class="bg-white border border-gray-200 rounded-xl shadow-md p-6 mb-8 space-y-4">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
        <p><span class="font-semibold">Full Name:</span> <span th:text="${experience.fullName}"></span></p>
        <p><span class="font-semibold">Company:</span>
          <span th:text="${experience.company.name == 'Other' ? experience.otherCompany : experience.company.name}"></span></p>
        <p><span class="font-semibold">Job Profile:</span>
          <span th:text="${experience.jobProfile == 'Other' ? experience.otherJobProfile : experience.jobProfile}"></span></p>
        <p><span class="font-semibold">Offer Type:</span> <span th:text="${experience.offerType}"></span></p>
        <p><span class="font-semibold">Internship Stipend:</span> <span th:text="${experience.internshipStipend}"></span></p>
        <p><span class="font-semibold">CTC:</span> <span th:text="${experience.ctc}"></span></p>
        <p><span class="font-semibold">Location:</span> <span th:text="${experience.location.name}"></span></p>
        <p><span class="font-semibold">Process Date:</span> <span th:text="${experience.processDate}"></span></p>
      </div>

      <div th:each="round, iStat : ${experience.parsedRounds}" class="bg-gray-50 border border-gray-200 rounded p-4 mt-4">
        <h4 class="font-semibold text-indigo-700 mb-2"
            th:text="'Round ' + ${iStat.index + 1} + ' - ' + (${round.roundType.equals('Other')} ? ${round.otherRoundType} : ${round.roundType})">
        </h4>
        <ul class="list-disc list-inside space-y-1 text-gray-800">
          <li th:each="q : ${round.questions}" th:utext="${q}"></li>
        </ul>
      </div>

      <div class="pt-4 border-t border-gray-200">
        <p class="mb-2">
          <span class="font-semibold text-gray-800">Comments:</span>
          <span th:utext="${experience.commentsWithLinks}"></span>
        </p>
        <p><span class="font-semibold text-gray-800">LinkedIn:</span>
          <a class="text-blue-600 underline break-words" th:href="${experience.linkedin}" target="_blank" th:text="${experience.linkedin}"></a>
        </p>
      </div>

    </div>
  </div>

</div>
<script>
  let roundCount = 0;

  function toggleCompanyInput() {
    const companySelect = document.getElementById('company');
    const companyInputDiv = document.getElementById('companyInputDiv');
    companyInputDiv.style.display = companySelect.value === 'Other' ? 'block' : 'none';
  }

  function toggleJobProfileInput() {
    const jobProfileSelect = document.getElementById('jobProfile');
    const jobProfileInputDiv = document.getElementById('jobProfileInputDiv');
    jobProfileInputDiv.style.display = jobProfileSelect.value === 'Other' ? 'block' : 'none';
  }

  function toggleOfferFields() {
    const offerType = document.getElementById('offerType').value;
    const stipendDiv = document.getElementById('stipendDiv');
    const ctcDiv = document.getElementById('ctcDiv');

    if (offerType === 'InternshipOnly') {
      stipendDiv.style.display = 'block';
      ctcDiv.style.display = 'none';
    } else if (offerType === 'PlacementOnly') {
      stipendDiv.style.display = 'none';
      ctcDiv.style.display = 'block';
    } else {
      stipendDiv.style.display = 'block';
      ctcDiv.style.display = 'block';
    }
  }

  function toggleRoundTypeInput(roundNumber) {
    const roundTypeSelect = document.getElementById(`roundType${roundNumber}`);
    const roundTypeInputDiv = document.getElementById(`roundTypeInputDiv${roundNumber}`);
    roundTypeInputDiv.style.display = roundTypeSelect.value === 'Other' ? 'block' : 'none';
  }

  function addRound() {
    roundCount++;
    const newRound = document.createElement('div');
    newRound.classList.add('round-section', 'p-4', 'mb-4', 'rounded-xl', 'border', 'border-indigo-300', 'bg-indigo-50', 'shadow-sm');
    newRound.id = `round${roundCount}`;
    newRound.innerHTML = `
      <div class="round-header font-semibold text-lg text-indigo-700 mb-4">Round ${roundCount}</div>

      <label for="roundType${roundCount}" class="block font-medium text-sm text-gray-700 mb-1">Round Type:</label>
      <select id="roundType${roundCount}" name="roundType${roundCount}" onchange="toggleRoundTypeInput(${roundCount})" required
              class="w-full p-2 mb-4 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white">
          <option value="Online Assessment">Online Assessment</option>
          <option value="Technical">Technical</option>
          <option value="HR">HR</option>
          <option value="Other">Other</option>
      </select>

      <div id="roundTypeInputDiv${roundCount}" class="input-box mb-4 hidden">
          <label for="otherRoundType${roundCount}" class="block font-medium text-sm text-gray-700 mb-1">Please specify the round type:</label>
          <input type="text" id="otherRoundType${roundCount}" name="otherRoundType${roundCount}" placeholder="Enter round type"
                 class="w-full p-2 border border-slate-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white">
      </div>

      <div class="question-section" id="questions${roundCount}">
          <label class="block font-medium text-sm text-gray-700 mb-2">Description:</label>
          <div class="question mb-4">
              <textarea id="q${roundCount}_1" name="q${roundCount}_1" rows="10" cols="50" placeholder="Describe the round, number of students who appeared, number selected, and any relevant details or approach." required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-300"></textarea>
          </div>
      </div>
      <span class="remove-round inline-block px-3 py-1.5 text-sm font-medium text-red-600 border border-red-300 hover:bg-red-50 rounded-md cursor-pointer transition-colors ml-3" onclick="removeRound(${roundCount})"> ðŸ—‘ Remove Round </span>
    `;
    document.getElementById('roundsContainer').appendChild(newRound);
  }

  function addQuestion(roundNumber) {
    const questionCount = document.getElementById(`questions${roundNumber}`).getElementsByClassName('question').length + 1;
    const newQuestion = document.createElement('div');
    newQuestion.classList.add('question', 'mb-4');
    newQuestion.innerHTML = `
      <label for="q${roundNumber}_${questionCount}" class="block text-sm font-semibold text-gray-700 mb-1">Question ${questionCount}:</label>
      <textarea id="q${roundNumber}_${questionCount}" name="q${roundNumber}_${questionCount}" rows="4" cols="50" placeholder="Describe the question and your approach." required
                class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-300"></textarea>
    `;
    document.getElementById(`questions${roundNumber}`).appendChild(newQuestion);
  }

  function removeRound(roundNumber) {
    const round = document.getElementById(`round${roundNumber}`);
    if (round){
      round.remove();
      roundCount--;
     }
    const rounds = document.querySelectorAll('.round-section');
    rounds.forEach((round, index) => {
      const header = round.querySelector('.round-header');
      if (header) header.textContent = `Round ${index + 1}`;
    });
  }

  window.onload = function () {
    toggleCompanyInput();
    toggleJobProfileInput();
    toggleOfferFields();
    addRound();
  };
</script>
</body>
</html>
